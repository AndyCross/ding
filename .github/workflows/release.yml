name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-arm64:
    runs-on: macos-15  # macOS Sequoia Apple Silicon
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
    
    - name: Build (Release)
      run: swift build -c release
    
    - name: Prepare artifact
      run: |
        mkdir -p dist
        cp .build/release/ding dist/ding-macos-arm64
        # Copy icons for distribution
        cp -r Resources/icons dist/
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ding-macos-arm64
        path: dist/
        if-no-files-found: error

  build-x86_64:
    runs-on: macos-15-large  # macOS Sequoia Intel (x86_64)
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
    
    - name: Build (Release)
      run: swift build -c release
    
    - name: Prepare artifact
      run: |
        mkdir -p dist
        cp .build/release/ding dist/ding-macos-x86_64
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ding-macos-x86_64
        path: dist/ding-macos-x86_64
        if-no-files-found: error

  release:
    needs: [build-arm64, build-x86_64]
    runs-on: macos-15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download ARM64 artifact
      uses: actions/download-artifact@v4
      with:
        name: ding-macos-arm64
        path: arm64/
    
    - name: Download x86_64 artifact
      uses: actions/download-artifact@v4
      with:
        name: ding-macos-x86_64
        path: x86_64/
    
    - name: Create Universal Binary
      run: |
        mkdir -p release
        
        # Create universal binary
        lipo -create \
          arm64/ding-macos-arm64 \
          x86_64/ding-macos-x86_64 \
          -output release/ding
        
        # Make executable
        chmod +x release/ding
        
        # Copy icons
        cp -r arm64/icons release/
        
        # Verify
        file release/ding
        lipo -info release/ding
    
    - name: Create archives
      run: |
        cd release
        
        # Universal binary archive (recommended)
        tar -czvf ../ding-macos-universal.tar.gz ding icons/
        
        # Individual architecture archives
        cp ../arm64/ding-macos-arm64 ding-arm64
        tar -czvf ../ding-macos-arm64.tar.gz ding-arm64 icons/
        
        cp ../x86_64/ding-macos-x86_64 ding-x86_64  
        tar -czvf ../ding-macos-x86_64.tar.gz ding-x86_64
        
        cd ..
        
        # Generate checksums
        shasum -a 256 ding-macos-*.tar.gz > checksums.txt
        cat checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          ding-macos-universal.tar.gz
          ding-macos-arm64.tar.gz
          ding-macos-x86_64.tar.gz
          checksums.txt
        body: |
          ## Installation
          
          ### Quick Install (Universal Binary - recommended)
          ```bash
          # Download and extract
          curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ding-macos-universal.tar.gz | tar xz
          
          # Install
          sudo mv ding /usr/local/bin/
          mkdir -p ~/.ding && mv icons ~/.ding/
          
          # Verify
          ding --version
          ```
          
          ### Homebrew (coming soon)
          ```bash
          brew install ding
          ```
          
          ### Manual Install
          1. Download `ding-macos-universal.tar.gz` (works on both Intel and Apple Silicon)
          2. Extract: `tar xzf ding-macos-universal.tar.gz`
          3. Move to PATH: `sudo mv ding /usr/local/bin/`
          4. Install icons (optional): `mkdir -p ~/.ding && mv icons ~/.ding/`
          
          ## Quick Start
          ```bash
          ding "Hello World" -t "Ding"
          ding install  # Auto-configure AI agent hooks
          ding status   # Check installation
          ```
          
          See [README](https://github.com/${{ github.repository }}#readme) for full documentation.
