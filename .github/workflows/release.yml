name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15  # macOS Sequoia Apple Silicon
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
    
    - name: Build Ding.app
      run: ./scripts/build-app.sh --release
    
    - name: Show app info
      run: |
        ls -la Ding.app/Contents/
        ls -la Ding.app/Contents/MacOS/
        file Ding.app/Contents/MacOS/ding
        cat Ding.app/Contents/Info.plist
    
    - name: Create archives
      run: |
        # Create zip of the app bundle (preferred for macOS apps)
        zip -r Ding-macos-arm64.zip Ding.app
        
        # Also create tarball for those who prefer it
        tar -czvf Ding-macos-arm64.tar.gz Ding.app
        
        # Generate checksums
        shasum -a 256 Ding-macos-arm64.zip Ding-macos-arm64.tar.gz > checksums.txt
        cat checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          Ding-macos-arm64.zip
          Ding-macos-arm64.tar.gz
          checksums.txt
        body: |
          ## Installation
          
          ### Quick Install (Recommended)
          ```bash
          # Download and extract
          curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/Ding-macos-arm64.zip -o Ding.zip
          unzip Ding.zip
          
          # Move to Applications
          mv Ding.app /Applications/
          
          # Create CLI symlink (optional, for terminal usage)
          sudo ln -sf /Applications/Ding.app/Contents/MacOS/ding /usr/local/bin/ding
          
          # Run once to register for notifications
          /Applications/Ding.app/Contents/MacOS/ding "Ding installed!" -t "Welcome"
          ```
          
          ### Manual Install
          1. Download `Ding-macos-arm64.zip`
          2. Unzip and drag `Ding.app` to `/Applications/`
          3. For CLI usage: `sudo ln -sf /Applications/Ding.app/Contents/MacOS/ding /usr/local/bin/ding`
          
          ### First Run
          On first notification, macOS will ask for permission. Click "Allow" to enable notifications.
          You can manage Ding's notification settings in **System Settings → Notifications → Ding**.
          
          > **Note**: This release is for Apple Silicon (M1/M2/M3/M4) Macs.
          > Intel Mac users can build from source: `./scripts/build-app.sh --release`
          
          ## Quick Start
          ```bash
          ding "Hello World" -t "Ding"
          ding install  # Auto-configure AI agent hooks
          ding status   # Check installation
          ```
          
          See [README](https://github.com/${{ github.repository }}#readme) for full documentation.
