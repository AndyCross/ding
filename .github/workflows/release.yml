name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15  # macOS Sequoia Apple Silicon
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
    
    - name: Build (Release)
      run: swift build -c release
    
    - name: Prepare release
      run: |
        mkdir -p release
        cp .build/release/ding release/
        cp -r Resources/icons release/
        
        # Show binary info
        file release/ding
        ls -lh release/ding
    
    - name: Create archive
      run: |
        cd release
        tar -czvf ../ding-macos-arm64.tar.gz ding icons/
        cd ..
        
        # Generate checksum
        shasum -a 256 ding-macos-arm64.tar.gz > checksums.txt
        cat checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          ding-macos-arm64.tar.gz
          checksums.txt
        body: |
          ## Installation
          
          ### Quick Install (Apple Silicon)
          ```bash
          # Download and extract
          curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ding-macos-arm64.tar.gz | tar xz
          
          # Install
          sudo mv ding /usr/local/bin/
          mkdir -p ~/.ding && mv icons ~/.ding/
          
          # Verify
          ding --version
          ```
          
          ### Manual Install
          1. Download `ding-macos-arm64.tar.gz`
          2. Extract: `tar xzf ding-macos-arm64.tar.gz`
          3. Move to PATH: `sudo mv ding /usr/local/bin/`
          4. Install icons (optional): `mkdir -p ~/.ding && mv icons ~/.ding/`
          
          > **Note**: This release is for Apple Silicon (M1/M2/M3) Macs only.
          > Intel Mac users can build from source: `swift build -c release`
          
          ## Quick Start
          ```bash
          ding "Hello World" -t "Ding"
          ding install  # Auto-configure AI agent hooks
          ding status   # Check installation
          ```
          
          See [README](https://github.com/${{ github.repository }}#readme) for full documentation.
